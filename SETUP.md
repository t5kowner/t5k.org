Setup
=====
Dependencies
------------
While I'm sure it's possible to run T5K on virtually any linux distro, the production site runs on Ubuntu, so subsequent instructions will assume this. I recommend setting up a Ubuntu VM for testing.

First, you need to install a bunch of packages. The following commands will install all packages needed to run the site (and potentially extra that are now unused):
```
dpkg --add-architecture i386
apt install php-gmp pari-gp gnuplot php-htmlpurifier sendmail apache2 mariadb-server mariadb-client php php-mysql perl letsencrypt g++ libgmp3-dev libssl-dev texlive-extra-utils zlib1g-dev gcc-multilib libstdc++5:i386 libgmp-dev:i386 php-tidy
cpan install YAML Log::Log4perl Math::Pari Regexp::Common LWP::UserAgent LWP::UserAgent::Determined Net::SSLeay IO::Socket::SSL LWP::Protocol::https
```

Some of these need some extra steps.
First, enable the needed apache module with `a2enmod cgi`.
Next, you will need to manually patch [this pull request](https://github.com/ezyang/htmlpurifier/pull/224/files) if Ubuntu hasn't updated the package yet. Files are under `/usr/share/php/HTMLPurifier`.
Finally, you'll want to increase parimaxsize in `/etc/gprc` - I believe 100M works for every prime in T5K at the moment.

SQL
---
Due to sensitive information, not all SQL data is available publically. The schema is completely public and can be downloaded from [here](https://t5k.org/public.sql). Additionally, you'll need to create `primes_` and `primes_admin` users and give them the following grants:
```
GRANT USAGE ON *.* TO `primes_`@`localhost` IDENTIFIED BY PASSWORD '<your password here>'
GRANT SELECT, INSERT, UPDATE ON `primes`.* TO `primes_`@`localhost`
GRANT SELECT, INSERT, UPDATE ON `curios`.* TO `primes_`@`localhost`
GRANT SELECT, INSERT, UPDATE ON `glossary`.* TO `primes_`@`localhost`
GRANT DELETE ON `primes`.`archival_tag` TO `primes_`@`localhost`

GRANT ALL PRIVILEGES
GRANT USAGE ON *.* TO `primes_admin`@`localhost` IDENTIFIED BY PASSWORD '<your password here>'
GRANT ALL PRIVILEGES ON `primes`.* TO `primes_admin`@`localhost`
GRANT ALL PRIVILEGES ON `curios`.* TO `primes_admin`@`localhost`
GRANT ALL PRIVILEGES ON `glossary`.* TO `primes_admin`@`localhost`
```

If you require some rows in the database for your development, reach out! Leave a comment on the issue/discussion you're looking into about what you need, and an admin will likely be able to make some information available.

Generated/Ignored Files
-----------------------
There's a few files that contain environment secrets or are generated by various scripts, so they aren't stored in git. Most generated files aren't needed during routine development - if you need them, check out the .gitignore for what script makes them.

Files that require additional work are listed below if you need them:
- pi2.dat - used for the nth primes page. Download from [here](https://drive.google.com/file/d/1V9SHr-qp0XNrwPABDlt00i35odV3-J7e/view?usp=drive_link).
- .htpasswd - create your own version under glossary/admin and curios/bin using standard apache tools.
- environment.inc, environment.pm, verify.ini - these all have corresponding .example files you can copy and change the constants in.
- pfgw64 - download your own copy from [sourceforge](https://sourceforge.net/projects/openpfgw/).
- piofx, nthprime - compile from the corresponding source files with gcc.
